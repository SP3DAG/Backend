# GeoCam Backend

This is a backend server for the GeoCam mobile app, developed as a study project by the Institute for Geoinformatics at the University of MÃ¼nster.

It enables cryptographic verification of geo-signed images captured by the GeoCam app. These images contain embedded metadata such as geolocation, timestamp, and a cryptographic signature generated by the capturing device.

More information about the GeoCam app can be found under [GeoCam](https://sp3dag.github.io/geocam-webclient/).

---

## Project Purpose

Disinformation and manipulated visual media are growing threats in today's digital world. GeoCam offers a solution by allowing users to capture signed, geotagged photos that can later be verified for authenticity.

This backend facilitates that verification by managing device public keys and verifying signatures on submitted images.

---

## Features

- Secure device linking using cryptographic tokens
- Public key registration for trusted devices
- Image signature verification using stored keys
- Public key registry download endpoint
- Cross-origin request support via CORS

---

## API Endpoints

### GET `/`

Health check endpoint.

**Response:**
```json
{
  "message": "GeoCam backend running"
}
```

---

### GET `/api/generate-link-token`

Generates a temporary token and a unique device UUID for establishing trust between the mobile app and backend.

**Response:**
```json
{
  "token": "<secure_token>",
  "device_uuid": "GeoCam_1"
}
```

Notes:
- Tokens are valid for 10 minutes
- Used by the app to register its public key

---

### POST `/api/complete-link`

Completes device registration by submitting a public key tied to a token.

**Form Fields:**
- `token`: The linking token received earlier
- `public_key`: PEM-formatted public RSA key

**Response:**
```json
{
  "success": true,
  "device_uuid": "GeoCam_1"
}
```

---

### POST `/verify-image/`

Verifies the authenticity of a geo-signed image using the registered public key of the originating device.

**Form Fields:**
- `file`: The image file to be verified

**Response:**
```json
{
  "decoded_message": "<verified_payload>",
  "status": "verified" or "verified_but_image_modified"
}
```

**Possible Errors:**
- `422`: Invalid signature or unreadable image
- `404`: Public key for the device not found
- `500`: Unexpected server error

---

### GET `/api/public-keys`

Downloads the full JSON registry of all submitted public keys.

**Response:**
- Returns `public_keys.json`

```json
{
  "GeoCam_1": "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkq...\n-----END PUBLIC KEY-----"
}
```

---

## Public Key Handling

- Public keys are:
  - Stored in memory for fast access
  - Persisted to disk as `.pem` files
  - Indexed in `public_keys.json` for external usage
- Persistence path is configurable via `PERSIST_DIR` (default: `/var/data`)

---

## Running Locally

This backend is no longer hosted online and must be run locally.

Start the server with:

```bash
uvicorn main:app --host 0.0.0.0 --port 10000
```

To allow access from another device (e.g. your phone), determine your local IP address:

**macOS (Wi-Fi):**
```bash
ipconfig getifaddr en0
```

**Linux:**
```bash
ip a | grep inet
```

**Windows:**
```bash
ipconfig
```

Use that IP with port `10000` to access the backend, for example:

```
http://192.168.1.42:10000/verify-image/
```

Ensure both devices are on the same network.

---

## Dependencies

Install required Python packages:

```bash
pip install -r requirements.txt
```

Also install the `zbar` QR decoding library:

**macOS:**
```bash
brew install zbar
```

```
# Apple Silicon
export DYLD_LIBRARY_PATH=/opt/homebrew/lib:$DYLD_LIBRARY_PATH

# Intel
export DYLD_LIBRARY_PATH=/usr/local/lib:$DYLD_LIBRARY_PATH
```

**Debian/Ubuntu:**
```bash
sudo apt install libzbar0
```

**Windows:**
Install the ZBar binaries from the [official repository](https://github.com/mchehab/zbar).

---